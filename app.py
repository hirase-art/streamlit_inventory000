import streamlit as st
import pandas as pd
import numpy as np

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(page_title="åœ¨åº«åˆ¤å®šãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—", layout="wide")

st.title("ğŸ“¦ æ¬¡ä¸–ä»£ åœ¨åº«èª¿é”æ„æ€æ±ºå®šãƒ„ãƒ¼ãƒ«")
st.markdown("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®é™ç•Œã‚’è¶…ãˆã€çµŒå–¶æŒ‡æ¨™ï¼ˆåœ¨åº«å›è»¢ãƒ»æ¬ å“é˜²æ­¢ï¼‰ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆæ“ä½œãƒ‘ãƒãƒ«ï¼‰ ---
st.sidebar.header("ğŸ› åˆ¤å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿")
st.sidebar.write("è£½é€ éƒ¨é–€é•·ãƒ»çµŒå–¶å±¤ãŒèª¿æ•´ã™ã‚‹å¤‰æ•°ã§ã™ã€‚")

# 1. éœ€è¦äºˆæ¸¬ã®ä¿‚æ•°ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰
# 1.0ã‚’åŸºæº–ã«ã€ç¹å¿™æœŸã‚„æ–½ç­–ã«åˆã‚ã›ã¦å¢—æ¸›
coeff = st.sidebar.slider(
    "éœ€è¦äºˆæ¸¬ä¿‚æ•°ï¼ˆæœˆåˆ¥ä¿‚æ•°ï¼‰", 
    min_value=0.5, 
    max_value=2.0, 
    value=1.0, 
    step=0.1,
    help="ç›´è¿‘4é€±é–“ã®å®Ÿç¸¾ã«å¯¾ã—ã€æ¥æœˆã®äºˆæ¸¬ã‚’ä½•å€ã«ã™ã‚‹ã‹èª¿æ•´ã—ã¾ã™ã€‚"
)

# 2. ç›®æ¨™åœ¨åº«æœˆæ•°ï¼ˆå®‰å…¨åœ¨åº«ã®è€ƒãˆæ–¹ï¼‰
target_mos = st.sidebar.slider(
    "ç›®æ¨™åœ¨åº«æœˆæ•°ï¼ˆæœ€ä½ä¿æŒï¼‰", 
    min_value=0.5, 
    max_value=2.0, 
    value=1.0, 
    step=0.1,
    help="åœ¨åº«ãŒä½•ãƒ¶æœˆåˆ†ã‚’åˆ‡ã£ãŸã‚‰ã€è¦ç™ºæ³¨ã€ã¨å‡ºã™ã‹ã®åŸºæº–ã§ã™ã€‚"
)

st.sidebar.divider()
st.sidebar.info(f"ç¾åœ¨ã®è¨­å®š:\n\näºˆæ¸¬: å®Ÿç¸¾ã® {coeff} å€\nç™ºæ³¨åŸºæº–: {target_mos} ãƒ¶æœˆåˆ†æœªæº€")

# --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ ---
# æœ¬æ¥ã¯ã“ã“ã§ Supabase ã‹ã‚‰ T_9x07 ç­‰ã‚’èª­ã¿è¾¼ã¿ã¾ã™
@st.cache_data
def load_data():
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã®ä¾‹ï¼ˆ100022ãªã©ï¼‰ã‚’å†ç¾ã—ãŸãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
    data = {
        "å•†å“ID": ["100022", "100125", "100200", "100350"],
        "å•†å“å": ["ã‚³ã‚³ï¼¿ãƒ•ã‚£ãƒƒã‚·ãƒ¥100g", "ã‚³ã‚³ã‚°ãƒ«ãƒ¡ï¼¿ãƒ“ãƒ¼ãƒ•", "ã‚µãƒ³ãƒ—ãƒ«å“A", "æ»ç•™å“B"],
        "ç¾åœ¨åº«": [61456, 3188, 12000, 45000],
        "å…¥è·äºˆå®š": [0, 5000, 0, 0],
        "é€±1": [18000, 1200, 3000, 200], # ç›´è¿‘(å…ˆé€±)
        "é€±2": [17500, 1150, 2800, 250],
        "é€±3": [18200, 1300, 3100, 220],
        "é€±4": [17900, 1250, 2950, 210]  # 4é€±å‰
    }
    return pd.DataFrame(data)

df = load_data()

# --- ãƒ­ã‚¸ãƒƒã‚¯è¨ˆç®—éƒ¨åˆ† ---
def process_logic(df, coeff, target):
    # 1. å®Œäº†4é€±ã®å¹³å‡ã‚’ç®—å‡º
    df['ç›´è¿‘4é€±å¹³å‡'] = df[['é€±1', 'é€±2', 'é€±3', 'é€±4']].mean(axis=1)
    
    # 2. æœˆé–“äºˆæ¸¬å‡ºè·æ•° X ã®ç®—å‡º (4.4é€±æ›ç®— * ä¿‚æ•°)
    df['äºˆæ¸¬æœˆé–“å‡ºè·(X)'] = (df['ç›´è¿‘4é€±å¹³å‡'] * 4.4 * coeff).astype(int)
    
    # 3. åœ¨åº«æœˆæ•° (MOS) ã®ç®—å‡º
    # (ç¾åœ¨åº« + å…¥è·äºˆå®š) / X
    df['åœ¨åº«æœˆæ•°(MOS)'] = (df['ç¾åœ¨åº«'] + df['å…¥è·äºˆå®š']) / df['äºˆæ¸¬æœˆé–“å‡ºè·(X)']
    
    # 4. åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
    def judge(row):
        mos = row['åœ¨åº«æœˆæ•°(MOS)']
        arrival = row['å…¥è·äºˆå®š']
        
        if mos < 0.5:
            return "ğŸš¨ é–“ã«åˆã‚ãªã„"
        elif mos < target:
            return "â³ å…¥è·å¾…ã¡" if arrival > 0 else "âš ï¸ è¦ç™ºæ³¨"
        elif mos > 3.0:
            return "ğŸ’° åœ¨åº«éå¤š"
        else:
            return "âœ… é©æ­£"
            
    df['åˆ¤å®š'] = df.apply(judge, axis=1)
    return df

# è¨ˆç®—å®Ÿè¡Œ
res_df = process_logic(df, coeff, target_mos)

# --- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ ---

# 100022ã®ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
st.subheader("ğŸ” é‡è¦å•†å“ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ— (100022)")
target_row = res_df[res_df['å•†å“ID'] == "100022"].iloc[0]
col1, col2, col3, col4 = st.columns(4)
col1.metric("åˆ¤å®š", target_row['åˆ¤å®š'])
col2.metric("åœ¨åº«æœˆæ•°", f"{target_row['åœ¨åº«æœˆæ•°(MOS)']:.2f} ãƒ¶æœˆ")
col3.metric("ç¾åœ¨åº«", f"{target_row['ç¾åœ¨åº«']:,}")
col4.metric("æœˆé–“äºˆæ¸¬(X)", f"{target_row['äºˆæ¸¬æœˆé–“å‡ºè·(X)']:,}")

st.divider()

# ä¸€è¦§è¡¨ã®è¡¨ç¤º
st.subheader("ğŸ“‹ å•†å“åˆ¥ åœ¨åº«åˆ¤å®šä¸€è¦§")

# è¦‹æ „ãˆã‚’è‰¯ãã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
def color_judge(val):
    if 'ğŸš¨' in val: color = '#ff4b4b'
    elif 'âš ï¸' in val: color = '#ffa500'
    elif 'ğŸ’°' in val: color = '#1f77b4'
    elif 'â³' in val: color = '#777777'
    else: color = '#28a745'
    return f'color: {color}; font-weight: bold'

st.dataframe(
    res_df.style.applymap(color_judge, subset=['åˆ¤å®š']),
    use_container_width=True,
    column_config={
        "ç›´è¿‘4é€±å¹³å‡": st.column_config.NumberColumn(format="%d"),
        "äºˆæ¸¬æœˆé–“å‡ºè·(X)": st.column_config.NumberColumn(format="%d"),
        "åœ¨åº«æœˆæ•°(MOS)": st.column_config.NumberColumn(format="%.2f ãƒ¶æœˆ"),
    }
)

# --- çµŒå–¶ã¸ã®ä¸€è¨€ã‚¢ãƒ‰ãƒã‚¤ã‚¹ ---
st.info(f"""
**ğŸ’¡ ç¾å ´ã¸ã®æŒ‡ç¤ºå‡ºã—ãƒã‚¤ãƒ³ãƒˆ:**
- ç¾åœ¨ã®éœ€è¦äºˆæ¸¬ä¿‚æ•° **{coeff}** ã«ãŠã„ã¦ã€åœ¨åº«æœˆæ•°ãŒ **{target_mos}ãƒ¶æœˆ** ã‚’åˆ‡ã‚‹å•†å“ã¯ã€Œç™ºæ³¨æ¤œè¨ã€ãŒå¿…è¦ã§ã™ã€‚
- 100022ã¯ç¾åœ¨åœ¨åº«æœˆæ•°ãŒ **{target_row['åœ¨åº«æœˆæ•°(MOS)']:.2f}ãƒ¶æœˆ** ã§ã™ã€‚ä¿‚æ•°ã‚’ä¸Šã’ã‚‹ã¨ã€ã‚ˆã‚Šæ—©ãã‚¢ãƒ©ãƒ¼ãƒˆãŒå‡ºã¾ã™ã€‚
""")
